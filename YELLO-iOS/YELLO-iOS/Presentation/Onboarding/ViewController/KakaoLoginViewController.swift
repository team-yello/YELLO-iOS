//
//  KakaoLoginViewController.swift
//  YELLO-iOS
//
//  Created by ÏßÄÌù¨Ïùò MAC on 2023/07/15.
//

import UIKit
import KakaoSDKUser

class KakaoLoginViewController: BaseViewController {
    
    let baseView = KakaoLoginView()
    override func loadView() {
        view = baseView
    }
    
    override func viewDidLoad() {
        super.viewDidLoad()
        addTarget()
    }
    
    func addTarget() {
        baseView.kakaoButton.addTarget(self, action: #selector(kakaoLoginButtonDidTap), for: .touchUpInside)
    }
    
    @objc func kakaoLoginButtonDidTap() {
        /// Ïπ¥Ïπ¥Ïò§ÌÜ° Ïã§Ìñâ Í∞ÄÎä• Ïó¨Î∂Ä ÌôïÏù∏
        /// isKakaoTalkLoginAvailable() : Ïπ¥ÌÜ° ÏÑ§Ïπò ÎêòÏñ¥ÏûàÏúºÎ©¥ true
        
        if UserApi.isKakaoTalkLoginAvailable() {
            UserApi.shared.loginWithKakaoTalk {(oauthToken, error) in
                if let error = error {
                    print(error)
                } else {
                    print("----üö©Ïπ¥Ïπ¥Ïò§ ÌÜ°ÏúºÎ°ú Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µüö©----")
                    
                    guard let kakaoToken = oauthToken?.accessToken else { return }
                    let queryDTO = KakaoLoginRequestDTO(accessToken: kakaoToken, social: "Kakao")
                    
                    NetworkService.shared.onboardingService.postTokenChange(queryDTO: queryDTO) { result in
                        
                        switch result {
                        case .success(let data):
                            if data.status == 403 {
                                self.navigationController?.pushViewController(KakaoConnectViewController(), animated: true)
                            } else if data.status == 201 {
                                self.navigationController?.pushViewController(YELLOTabBarController(), animated: true)
                            }
                        default:
                            print("network failure")
                            
                            return
                        }
                    }
                    
                }
            }
        } else {
            // Ïπ¥ÌÜ° ÏóÜÏúºÎ©¥ -> Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏
            UserApi.shared.loginWithKakaoAccount { (oauthToken, error) in
                if let error = error {
                    print(error)
                } else {
                    print("Ïπ¥Ïπ¥Ïò§ Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ")
                    
                    guard let kakaoToken = oauthToken?.accessToken else { return }
                    let queryDTO = KakaoLoginRequestDTO(accessToken: kakaoToken, social: "Kakao")
                    
                    NetworkService.shared.onboardingService.postTokenChange(queryDTO: queryDTO) { result in
                        switch result {
                        case .success(let data):
                            if data.status == 403 {
                                self.navigationController?.pushViewController(KakaoConnectViewController(), animated: true)
                            } else if data.status == 201 {
                                self.navigationController?.pushViewController(YELLOTabBarController(), animated: true)
                            }
//                            guard let data = data.data else {
//                                print("no data")
//                                return
//                            }
                        default:
                            print("network failure")
                            return
                        }
                    }
                    
                    _ = oauthToken
                    
                    // Í¥ÄÎ†® Î©îÏÜåÎìú Ï∂îÍ∞Ä
                }
            }
        }
    }
    
}
